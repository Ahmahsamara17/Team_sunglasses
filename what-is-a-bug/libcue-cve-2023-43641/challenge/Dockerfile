FROM ubuntu:24.04
RUN apt-get update && apt-get install -y cmake build-essential python3-pwntools git flex bison
ADD --chown=0:0 --chmod=6755 http://github.com/pwncollege/exec-suid/releases/latest/download/exec-suid /usr/bin/exec-suid
COPY parse_cue.c crash_to_flag.c /challenge/
RUN <<END
    set -e
    mkdir -p /challenge/bin
    cd /challenge

    git clone https://github.com/lipnitsk/libcue
    git config --global user.email "you@example.com"
    git config --global user.name "Your Name"
    git -C libcue revert fdf72c8bded8d24cfa0608b8e97f2eed210a920e
    git -C libcue diff HEAD^ > /challenge/patch.diff

    mkdir /challenge/libcue/build
    cd /challenge/libcue/build
    cmake -DCMAKE_INSTALL_PREFIX=/challenge -DCMAKE_BUILD_TYPE=Release ../
    make
    make install
    git -C /challenge/libcue clean -fxxd

    gcc -I/challenge/include -o /challenge/bin/parse_cue /challenge/*.c -L/challenge/lib -lcue
    chmod 6755 /challenge/bin/parse_cue
END
