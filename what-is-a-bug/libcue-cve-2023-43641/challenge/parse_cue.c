#include <stdio.h>
#include <stdlib.h>
#include <libcue.h>

void print_track_info(Track *track, int track_num) {
    printf("  Track %02d:\n", track_num);

    Cdtext *cdtext = track_get_cdtext(track);
    if (cdtext) {
        const char *title = cdtext_get(PTI_TITLE, cdtext);
        if (title) {
            printf("    Title: %s\n", title);
        }

        const char *performer = cdtext_get(PTI_PERFORMER, cdtext);
        if (performer) {
            printf("    Performer: %s\n", performer);
        }
    }

    const char *isrc = track_get_isrc(track);
    if (isrc) {
        printf("    ISRC: %s\n", isrc);
    }

    long start = track_get_start(track);
    if (start >= 0) {
        int minutes = start / 60 / 75;
        int seconds = (start / 75) % 60;
        int frames = start % 75;
        printf("    Start: %02d:%02d:%02d\n", minutes, seconds, frames);
    }

    long length = track_get_length(track);
    if (length > 0) {
        int minutes = length / 60 / 75;
        int seconds = (length / 75) % 60;
        int frames = length % 75;
        printf("    Length: %02d:%02d:%02d\n", minutes, seconds, frames);
    }
}

int main(int argc, char *argv[]) {
    if (argc != 2) {
        fprintf(stderr, "Usage: %s <cue_file>\n", argv[0]);
        return 1;
    }

    const char *filename = argv[1];
    printf("Parsing CUE file: %s\n", filename);
    printf("=====================================\n\n");

    // Read the CUE file
    FILE *fp = fopen(filename, "r");
    if (!fp) {
        perror("Failed to open CUE file");
        return 1;
    }

    // Get file size
    fseek(fp, 0, SEEK_END);
    long file_size = ftell(fp);
    fseek(fp, 0, SEEK_SET);

    // Read file contents
    char *cue_content = (char *)malloc(file_size + 1);
    if (!cue_content) {
        fprintf(stderr, "Failed to allocate memory\n");
        fclose(fp);
        return 1;
    }

    size_t read_size = fread(cue_content, 1, file_size, fp);
    cue_content[read_size] = '\0';
    fclose(fp);

    // Parse the CUE sheet
    Cd *cd = cue_parse_string(cue_content);
    free(cue_content);

    if (!cd) {
        fprintf(stderr, "Failed to parse CUE file\n");
        return 1;
    }

    // Display CD information
    Cdtext *cdtext = cd_get_cdtext(cd);
    if (cdtext) {
        const char *title = cdtext_get(PTI_TITLE, cdtext);
        if (title) {
            printf("Album Title: %s\n", title);
        }

        const char *performer = cdtext_get(PTI_PERFORMER, cdtext);
        if (performer) {
            printf("Album Performer: %s\n", performer);
        }
    }

    const char *cdtextfile = cd_get_cdtextfile(cd);
    if (cdtextfile) {
        printf("CD-TEXT File: %s\n", cdtextfile);
    }

    int num_tracks = cd_get_ntrack(cd);
    printf("Number of Tracks: %d\n\n", num_tracks);

    // Display track information
    if (num_tracks > 0) {
        printf("Track Information:\n");
        for (int i = 1; i <= num_tracks; i++) {
            Track *track = cd_get_track(cd, i);
            if (track) {
                print_track_info(track, i);
            }
        }
    }

    // Clean up
    cd_delete(cd);

    return 0;
}