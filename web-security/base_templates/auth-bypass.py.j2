{%- extends "base_templates/flask.py.j2" -%}

{% block setup %}
  {{- super() -}}
  {%- set challenge.flask_host = "challenge.localhost" -%}
  {%- set challenge.auth_method = "param" -%}
  {%- set challenge.admin_password_length = 16 -%}
  {%- set challenge.guest_password = "password" -%}
{% endblock %}

{% block imports %}
import tempfile
import sqlite3
{% endblock %}

{% block handlers %}
{% include 'base_templates/temporarydb.py.j2' %}
# https://www.sqlite.org/lang_createtable.html
db.execute("""CREATE TABLE users AS SELECT "admin" AS username, ? as password""", [os.urandom({{challenge.admin_password_length}})])
# https://www.sqlite.org/lang_insert.html
db.execute("""INSERT INTO users SELECT "guest" as username, "{{challenge.guest_password}}" as password""")

@app.route("/", methods=["POST"])
def challenge_post():
    username = flask.request.form.get("username")
    password = flask.request.form.get("password")
    if not username:
        flask.abort(400, "Missing `username` form parameter")
    if not password:
        flask.abort(400, "Missing `password` form parameter")

    # https://www.sqlite.org/lang_select.html
    user = db.execute("SELECT rowid, * FROM users WHERE username = ? AND password = ?", (username, password)).fetchone()
    if not user:
        flask.abort(403, "Invalid username or password")

    {% if challenge.auth_method == "param" %}
    return flask.redirect(f"""{flask.request.path}?session_user={username}""")
    {% elif challenge.auth_method == "cookie" %}
    response = flask.redirect(flask.request.path)
    response.set_cookie('session_user', username)
    return response
    {% endif %}

@app.route("/", methods=["GET"])
def challenge_get():
    {%- if challenge.auth_method == "param" %}
    if not (username := flask.request.args.get("session_user", None)):
    {%- elif challenge.auth_method == "cookie" %}
    if not (username := flask.request.cookies.get("session_user", None)):
    {%- endif %}
        page = "<html><body>Welcome to the login service! Please log in as admin to get the flag."
    else:
        page = f"<html><body>Hello, {username}!"
        if username == "admin":
            page += "<br>Here is your flag: " + open("/flag").read()

    return page + """
        <hr>
        <form method=post>
        User:<input type=text name=username>Pass:<input type=text name=password><input type=submit value=Submit>
        </form>
        </body></html>
    """
{% endblock %}
