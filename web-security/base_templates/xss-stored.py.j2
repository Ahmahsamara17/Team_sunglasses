{%- extends "base_templates/flask.py.j2" -%}

{% block setup %}
  {{- super() -}}
  {%- set challenge.flask_host = "challenge.localhost" -%}
  {%- set challenge.service_name = "pwnpost" -%}
  {%- set challenge.escaping = False -%}
  {%- set challenge.msg_in_textarea = False -%}
{% endblock %}

{% block imports %}
import sqlite3
import tempfile
{% endblock %}

{% block handlers %}
{% include 'base_templates/temporarydb.py.j2' %}
db.execute("""CREATE TABLE posts AS SELECT "First Post!" AS content""")

@app.route("/", methods=["POST"])
def challenge_post():
    content = flask.request.form.get("content", "")
    db.execute("INSERT INTO posts VALUES (?)", [content])
    return flask.redirect(flask.request.path)

@app.route("/", methods=["GET"])
def challenge_get():
    page = "<html><body>\n{% block service_description %}Welcome to pwnpost, the anonymous posting service. Post away!{% endblock %}\n"
    page += "<form method=post>Post:<input type=text name=content><input type=submit value=Submit></form>\n"

    for post in db.execute("SELECT content FROM posts").fetchall():
        {% if challenge.escaping %}
        import html
        page += "<hr>" + html.escape(post["content"]) + "\n"
        {% else %}
        page += "<hr>" + post["content"] + "\n"
        {% endif %}

    return page + "</body></html>"
{% endblock %}
