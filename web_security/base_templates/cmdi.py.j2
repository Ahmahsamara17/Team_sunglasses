{%- extends "base_templates/flask.py.j2" -%}

{% block setup %}
  {%- from 'base_templates/names.j2' import generate_names -%}
  {{- generate_names(settings, challenge.random) -}}
  {%- set settings.flask_host = "challenge.localhost" -%}
  {%- set settings.reset_uid = True -%}
  {%- set settings.reset_path = True -%}
  {%- set settings.input_parameter = settings.parameter_directory -%}
  {%- set settings.default_parameter_value = "/challenge" -%}
{% endblock %}

{% block imports %}
import subprocess
{% endblock %}

{% block handlers %}

@app.route("/{{settings.endpoint_challenge}}", methods=["GET"])
def challenge():
    arg = flask.request.args.get("{{settings.input_parameter}}", "{{settings.default_parameter_value}}"){% block filter %}{% endblock %}

    command = {% block command %}f"ls -l {% block quote %}{% endblock %}{arg}{% block quote2 %}{% endblock %}"{% endblock %}

    print(f"DEBUG: {command=}")
    result = subprocess.run(
        command,  # the command to run
        shell=True,  # use the shell to run this command
        stdout=subprocess.PIPE,  # capture the standard output
        stderr=subprocess.STDOUT,  # 2>&1
        encoding="latin",  # capture the resulting output as text
    ).stdout

    return f"""
        <html><body>
        {% block service_description %}Welcome to the dirlister service! Please choose a directory to list the files of:{% endblock %}
        <form action="/{{settings.endpoint_challenge}}"><input type=text name={{settings.input_parameter}}><input type=submit value=Submit></form>
        <hr>
        {% if settings.hide_output %}
        <b>Ran {command}!</b><br>
        {% else %}
        <b>Output of {command}:</b><br>
        <pre>{result}</pre>
        {% endif %}
        </body></html>
        """

{% endblock %}
