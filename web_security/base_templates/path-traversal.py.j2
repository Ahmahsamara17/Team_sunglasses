{%- extends "base_templates/flask.py.j2" -%}

{% block setup %}
  {%- from 'base_templates/names.j2' import generate_names -%}
  {{- generate_names(settings, challenge.random) -}}
{% endblock %}

{% block handlers %}

@app.route("/{{settings.endpoint_static_files}}", methods=["GET"])
@app.route("/{{settings.endpoint_static_files}}/<path:path>", methods=["GET"])
def challenge(path="index.html"):
    requested_path = app.root_path + "/files/" + path{% block filter %}{% endblock %}

    {% if challenge.walkthrough %}print(f"DEBUG: {requested_path=}"){% endif %}

    try:
        return open(requested_path).read()
    except PermissionError:
        flask.abort(403, requested_path)
    except FileNotFoundError:
        flask.abort(404, f"No {requested_path} from directory {os.getcwd()}")
    except Exception as e:
        flask.abort(500, requested_path + ":" + str(e))

{% endblock %}

{% block initialization %}
os.makedirs(os.path.join(os.getcwd(), "files"), exist_ok=True)
{% endblock %}
